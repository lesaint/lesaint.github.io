<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="https://www.javatronic.fr/theme/css/elegant.prod.9e9d5ce754.css" media="screen">
        <link rel="stylesheet" type="text/css" href="https://www.javatronic.fr/theme/css/custom.css" media="screen">

        <link rel="dns-prefetch" href="//fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>

        <meta name="author" content="Sébastien Lesaint" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="Ubuntu, tips, " />

<meta property="og:title" content="Send email notification upon Ubuntu server restart "/>
<meta property="og:url" content="https://www.javatronic.fr/posts/2024/06/24/send-email-notification-upon-ubuntu-server-restart/" />
<meta property="og:description" content="I want to be notified by email upon restart of the remote server serving the HDD where I do the offsite backup of my data. I used init in the past for such purpose, combined with a script that sends an email. But init is gone and has been replaced …" />
<meta property="og:site_name" content="Javatronic" />
<meta property="og:article:author" content="Sébastien Lesaint" />
<meta property="og:article:published_time" content="2024-06-24T00:00:00+02:00" />
<meta name="twitter:title" content="Send email notification upon Ubuntu server restart ">
<meta name="twitter:description" content="I want to be notified by email upon restart of the remote server serving the HDD where I do the offsite backup of my data. I used init in the past for such purpose, combined with a script that sends an email. But init is gone and has been replaced …">

        <title>Send email notification upon Ubuntu server restart  · Javatronic
</title>
        <link href="https://www.javatronic.fr/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Javatronic - Full Atom Feed" />



    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="https://www.javatronic.fr/"><span class=site-name>Javatronic</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       https://www.javatronic.fr
                                    >Home</a>
                                </li>
                                <li ><a href="https://www.javatronic.fr/pages/sebastien_lesaint_resume/">Resume</a></li>
                                <li ><a href="https://www.javatronic.fr/pages/books-read/">Books read</a></li>
                                <li ><a href="https://www.javatronic.fr/categories.html">Categories</a></li>
                                <li ><a href="https://www.javatronic.fr/tags.html">Tags</a></li>
                                <li ><a href="https://www.javatronic.fr/archives.html">Archives</a></li>
                                <li><form class="navbar-search" action="https://www.google.com/search" onsubmit="return validateForm(this.elements['q'][0].value);" target="_blank"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"><input type="hidden" name="q" value="site:https://www.javatronic.fr"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<article itemscope>
<div class="row-fluid">
    <header class="page-header span10 offset2">
        <h1>
            <a href="https://www.javatronic.fr/posts/2024/06/24/send-email-notification-upon-ubuntu-server-restart/">
                Send email notification upon Ubuntu server restart
            </a>
        </h1>
    </header>
</div>

<div class="row-fluid">
    <div class="span2 table-of-content">
        <nav>
        <h4>Contents</h4>
        <div class="toc">
<ul>
<li><a href="#send-an-email">Send an email</a></li>
<li><a href="#create-the-service">Create the service</a></li>
<li><a href="#test-the-service">Test the service</a></li>
<li><a href="#enable-the-service">Enable the service</a></li>
<li><a href="#monitor-the-service">Monitor the service</a></li>
</ul>
</div>
        </nav>
    </div>
    <div class="span8 article-content">
            
            
<p>I want to be notified by email upon restart of the remote server serving the HDD where I do the offsite backup of my
data.</p>
<p>I used <code>init</code> in the past for such purpose, combined with a script that sends an email.</p>
<p>But <code>init</code> is gone and has been replaced by <code>systemd</code> in Ubuntu for a while now.</p>
<p>Yet, the same result can be achieved by creating a service in <code>systemd</code> and have it run only once.</p>
<h1 id="send-an-email">Send an email<a class="headerlink" href="#send-an-email" title="Permanent link">¶</a></h1>
<p>I'll create a script in my home directory that sends me an email: <code>vi ~/scripts/notify_start.sh</code>.</p>
<p>To prevent emails from stacking in the same conversation in Gmail, I'll include the current date and time in the subject
(plus it's a useful information, in case emails are delayed).</p>
<p>Since restarts happen only so often, I'll include instructions in the body of what and how I should be doing manually
upon restart, in case I forget.</p>
<p>I'll use <code>ssmtp</code> to send the email, see <a href="https://www.javatronic.fr/posts/2023/12/12/configure-ssmtp-with-gmail-on-ubuntu/">how to configure gmail with SSMTP on Ubuntu</a>.</p>
<p>I'll use the braces + pipe trick and the <code>echo</code> command to send multiple lines to <code>ssmtp</code> (over the harder to read <code>cat</code>
+ delimiter, which I find harder to read and maintain).</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env bash</span>

<span class="nb">set</span><span class="w"> </span>-euo<span class="w"> </span>pipefail

<span class="nv">DATE</span><span class="o">=</span><span class="k">$(</span>date<span class="w"> </span>+<span class="s2">"%Y-%m-%d-%H%M%S"</span><span class="k">)</span>
<span class="o">{</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"Subject: MyServer (re)started at </span><span class="nv">$DATE</span><span class="s2">"</span>
<span class="w">        </span><span class="nb">echo</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"This email is sent from systemd service notify_start.service on MyServer."</span>
<span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"Check service logs with either 'sudo systemctl status notify_start.service' or 'journalctl -u notify_start.service'."</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">""</span><span class="w"> </span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"Immediate actions to take:"</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">" * mount and open HDD with '/blablabla/mount.sh'"</span>
<span class="o">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>ssmtp<span class="w"> </span>me@gmail.com
</code></pre></div>
<h1 id="create-the-service">Create the service<a class="headerlink" href="#create-the-service" title="Permanent link">¶</a></h1>
<p>The unit of work in <code>systemd</code> is a <code>unit</code>. We will use one of type <code>service</code>, since <code>systemd</code> starts, stops and 
generally manages the lifecycle of those, and we can declare dependencies on other services (see below).</p>
<p>A unit is created with a configuration file. I'll use <code>/etc/systemd/system</code> as location since it prevails over any other
and I have root access.</p>
<p><code>sudo vi /etc/systemd/system/notify_start.service</code></p>
<ul>
<li>I create and a description to the unit
    <div class="highlight"><pre><span></span><code>[Unit]
Description=Send me an email when system starts
</code></pre></div></li>
<li>the unit is a service
    <div class="highlight"><pre><span></span><code>[Service]
</code></pre></div></li>
<li>the service calls the above script (upon starting):
    <div class="highlight"><pre><span></span><code>ExecStart=/home/phan/scripts/pidatabak_scripts/notify_start/notify_start.sh
</code></pre></div></li>
<li>the service must be started only once (to run the script only once):
    <div class="highlight"><pre><span></span><code>Type=oneshot
</code></pre></div></li>
<li>since the script sends an email, the service requires network to be available before running:
    <div class="highlight"><pre><span></span><code>After=network-online.target
Wants=network-online.target
</code></pre></div></li>
</ul>
<p>Side benefit: since the service just calls a script, it can be easily duplicated to serve other purpose.</p>
<h1 id="test-the-service">Test the service<a class="headerlink" href="#test-the-service" title="Permanent link">¶</a></h1>
<p>After testing the script, test the service with <code>sudo systemctl start notify_start.service</code>.</p>
<p>If service was already tested, stop it first: <code>sudo systemctl stop notify_start.service</code>.</p>
<h1 id="enable-the-service">Enable the service<a class="headerlink" href="#enable-the-service" title="Permanent link">¶</a></h1>
<p>To have the service managed by <code>systemd</code>, it needs to be enabled with <code>sudo systemctl enable notify_start.service</code>.</p>
<p>This fails with the following message:</p>
<div class="highlight"><pre><span></span><code>The unit files have no installation config (WantedBy=, RequiredBy=, Also=,
Alias= settings in the [Install] section, and DefaultInstance= for template
units). This means they are not meant to be enabled using systemctl.

Possible reasons for having this kind of units are:
• A unit may be statically enabled by being symlinked from another unit's
  .wants/ or .requires/ directory.
• A unit's purpose may be to act as a helper for some other unit which has
  a requirement dependency on it.
• A unit may be started when needed via activation (socket, path, timer,
  D-Bus, udev, scripted systemctl call, ...).
• In case of template units, the unit is meant to be enabled with some
  instance name specified.
</code></pre></div>
<p>To fix this, add the following:</p>
<div class="highlight"><pre><span></span><code>[Install]
WantedBy=multi-user.target
</code></pre></div>
<h1 id="monitor-the-service">Monitor the service<a class="headerlink" href="#monitor-the-service" title="Permanent link">¶</a></h1>
<ul>
<li>check logs with either <code>sudo systemctl status notify_start.service</code> or <code>journalctl -u notify_start.service</code></li>
<li>check status with <code>sudo systemctl status notify_start.service</code></li>
</ul>
<div class="highlight"><pre><span></span><code>[Unit]
Description=Send me an email when system starts
# source: https://systemd.io/NETWORK_ONLINE/
After=network-online.target
Wants=network-online.target

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/home/phan/scripts/pidatabak_scripts/notify_start/notify_start.sh

[Install]
WantedBy=multi-user.target
</code></pre></div>
<div class="admonition note">
<p class="admonition-title"> Sources</p>
<ul>
<li><a href="https://unix.stackexchange.com/a/506374">Fixing missing WantedBy</a></li>
<li><a href="https://www.digitalocean.com/community/tutorials/understanding-systemd-units-and-unit-files">Understanding Systemd Units and Unit Files</a></li>
</ul>
</div>


             
 
            
            
            







            <hr/>
        </div>
        <section id="article-sidebar" class="span2">
            <h4>Published</h4>
            <time itemprop="dateCreated" datetime="2024-06-24T00:00:00+02:00">Mon 24 June 2024</time>
            <h4>Category</h4>
            <a class="category-link" href="https://www.javatronic.fr/categories.html#tips-ref">tips</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="https://www.javatronic.fr/tags.html#ubuntu-ref">Ubuntu
                    <span class="superscript">4</span>
</a></li>
            </ul>
<h4>Contact</h4>
<div id="sidebar-social-link">
    <a href="https://linkedin.com/in/sebastien-lesaint/" title="Linkedin profile" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="LinkedIn" role="img" viewBox="0 0 512 512" fill="#fff"><rect width="512" height="512" rx="15%" fill="#0077b5"/><circle cx="142" cy="138" r="37"/><path stroke="#fff" stroke-width="66" d="M244 194v198M142 194v198"/><path d="M276 282c0-20 13-40 36-40 24 0 33 18 33 45v105h66V279c0-61-32-89-76-89-34 0-51 19-59 32"/></svg>
    </a>
    <a href="https://github.com/lesaint/" title="Personal Github" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="GitHub" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#1B1817"/><path fill="#fff" d="M335 499c14 0 12 17 12 17H165s-2-17 12-17c13 0 16-6 16-12l-1-50c-71 16-86-28-86-28-12-30-28-37-28-37-24-16 1-16 1-16 26 2 40 26 40 26 22 39 59 28 74 22 2-17 9-28 16-35-57-6-116-28-116-126 0-28 10-51 26-69-3-6-11-32 3-67 0 0 21-7 70 26 42-12 86-12 128 0 49-33 70-26 70-26 14 35 6 61 3 67 16 18 26 41 26 69 0 98-60 120-117 126 10 8 18 24 18 48l-1 70c0 6 3 12 16 12z"/></svg>
    </a>
    <a href="https://github.com/sns-seb/" title="Public Github at SonarSource" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="GitHub" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#1B1817"/><path fill="#fff" d="M335 499c14 0 12 17 12 17H165s-2-17 12-17c13 0 16-6 16-12l-1-50c-71 16-86-28-86-28-12-30-28-37-28-37-24-16 1-16 1-16 26 2 40 26 40 26 22 39 59 28 74 22 2-17 9-28 16-35-57-6-116-28-116-126 0-28 10-51 26-69-3-6-11-32 3-67 0 0 21-7 70 26 42-12 86-12 128 0 49-33 70-26 70-26 14 35 6 61 3 67 16 18 26 41 26 69 0 98-60 120-117 126 10 8 18 24 18 48l-1 70c0 6 3 12 16 12z"/></svg>
    </a>
</div>
            





            





        </section>
</div>
</article>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides.
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>




    <div id="fpowered">
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow noopener noreferrer">Pelican</a>
        Theme: <a href="https://github.com/lesaint/pelican-theme-elegant/" title="Theme Elegant Home Page" target="_blank" rel="nofollow noopener noreferrer">Personal fork of Elegant</a>
    </div>
</footer>            <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script src="https://www.javatronic.fr/theme/js/elegant.prod.9e9d5ce754.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    <script>
    (function () {
        if (window.location.hash.match(/^#comment-\d+$/)) {
            $('#comment_thread').collapse('show');
        }
    })();
    window.onhashchange=function(){
        if (window.location.hash.match(/^#comment-\d+$/))
            window.location.reload(true);
    }
    $('#comment_thread').on('shown', function () {
        var link = document.getElementById('comment-accordion-toggle');
        var old_innerHTML = link.innerHTML;
        $(link).fadeOut(200, function() {
            $(this).text('Click here to hide comments').fadeIn(200);
        });
        $('#comment_thread').on('hidden', function () {
            $(link).fadeOut(200, function() {
                $(this).text(old_innerHTML).fadeIn(200);
            });
        })
    })
</script>

    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>